<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login T√©cnico</title>

  <style>
    :root {
      --bg:#f8f9fa;
      --card-bg:#ffffff;
      --accent:#ff4800;
      --accent-light:#ffe0d3;
      --success:#28a745;
      --error:#dc3545;
      --text:#212529;
      --text-muted:#6c757d;
      --border:#dee2e6;
      --shadow:0 2px 8px rgba(0,0,0,.1);
      --radius:12px;
      --transition:all .3s ease;
    }

    body{
      font-family:'Segoe UI',Tahoma,Verdana,sans-serif;
      margin:0;
      padding:16px;
      max-width:720px;
      margin:auto;
      background:linear-gradient(135deg,var(--bg),#e9ecef);
      color:var(--text);
    }

    .card{
      background:var(--card-bg);
      padding:24px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      margin-top:40px;
      animation:fade .4s ease;
    }

    h1{
      color:var(--accent);
      margin-top:0;
      text-align:center;
    }

    label{
      display:block;
      margin-top:18px;
      font-weight:600;
    }

    input{
      width:100%;
      padding:12px 14px;
      font-size:16px;
      margin-top:6px;
      border-radius:var(--radius);
      border:1px solid var(--border);
      transition:var(--transition);
      box-sizing:border-box;
      line-height:1.4;
    }

    input:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px var(--accent-light);
    }

    button{
      width:100%;
      margin-top:24px;
      padding:14px;
      font-size:16px;
      font-weight:700;
      border-radius:var(--radius);
      border:none;
      cursor:pointer;
      background:linear-gradient(135deg,var(--accent),#ff8800);
      color:white;
      transition:var(--transition);
    }

    button:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    .msg{
      margin-top:16px;
      text-align:center;
      padding:10px;
      border-radius:var(--radius);
      font-size:14px;
      display:none;
    }

    .ok{
      display:block;
      background:#d4edda;
      color:var(--success);
      border:1px solid #c3e6cb;
    }

    .err{
      display:block;
      background:#f8d7da;
      color:var(--error);
      border:1px solid #f5c6cb;
    }

    .back{
      text-align:center;
      margin-top:16px;
      color:var(--accent);
      cursor:pointer;
      font-weight:600;
    }

    @keyframes fade{
      from{opacity:0; transform:translateY(10px)}
      to{opacity:1; transform:translateY(0)}
    }
  </style>
</head>

<body>

  <div class="card">
    <h1>üîê Login T√©cnico</h1>

    <label for="tecnico">T√©cnico</label>
    <input id="tecnico" list="tecnicosList" placeholder="Selecciona tu nombre">

    <datalist id="tecnicosList"></datalist>

    <label for="rut">RUT</label>
    <input id="rut" placeholder="12345678-9">

    <button id="loginBtn">Ingresar</button>

    <div id="msg" class="msg"></div>

    <div class="back" onclick="location.href='index.html'">
      ‚Üê Volver al inicio
    </div>
  </div>

  <script src="session.js"></script>
  <script>
    /******** CONFIG ********/
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyFtAK7pp8k4amh6bQL9V0NR1wmDnhPVRkJFITQKwfaFSDRVRt5dvo7H_nzzlUj9nOg/exec";
    const REDIRECT_OK = "index.html";

    const tecnicoInput = document.getElementById("tecnico");
    const rutInput = document.getElementById("rut");
    const list = document.getElementById("tecnicosList");
    const btn = document.getElementById("loginBtn");
    const msg = document.getElementById("msg");

    function cleanRut(r){
      return r.toUpperCase().replace(/\./g,"").replace(/\s/g,"");
    }

    function showMsg(text,type){
      msg.textContent = text;
      msg.className = "msg " + type;
    }

    // Si ya hay sesi√≥n, vuelve al men√∫
    if (isLogged()) {
      location.href = REDIRECT_OK;
    }

    // Cargar t√©cnicos
    fetch(SCRIPT_URL)
      .then(r=>r.json())
      .then(data=>{
        (data.Tecnicos || []).forEach(t=>{
          const o = document.createElement("option");
          o.value = t;
          list.appendChild(o);
        });
      })
      .catch(()=>alert("Error cargando t√©cnicos"));

    btn.addEventListener("click", async ()=>{
      msg.style.display="none";

      const tecnico = tecnicoInput.value.trim();
      const rut = cleanRut(rutInput.value.trim());

      if(!tecnico || !rut){
        showMsg("Completa t√©cnico y RUT","err");
        return;
      }

      btn.disabled = true;
      btn.textContent = "Verificando‚Ä¶";

      try{
        const res = await fetch(SCRIPT_URL,{
          method:"POST",
          headers:{ "Content-Type":"text/plain;charset=utf-8" },
          body:JSON.stringify({
            action:"verifyTech",
            tecnico,
            rut
          })
        });

        const out = await res.json();

        if(!out.ok){
          showMsg(out.error || "Credenciales incorrectas","err");
          return;
        }

        // Cookie por 12 horas
        setTechSession({
          verified:true,
          tecnico,
          at:new Date().toISOString()
        }, 12);

        showMsg("Ingreso correcto ‚úî","ok");
        setTimeout(()=>location.href=REDIRECT_OK,600);

      }catch(e){
        showMsg("Error de conexi√≥n","err");
      }finally{
        btn.disabled=false;
        btn.textContent="Ingresar";
      }
    });
  </script>

</body>
</html>
